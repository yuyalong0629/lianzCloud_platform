{"remainingRequest":"/Users/yuyalong/myProjects/lianzhiyun/projects/web-projects/platform/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/yuyalong/myProjects/lianzhiyun/projects/web-projects/platform/src/views/product/pdm/goods/child_info/GoodsInfo.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/yuyalong/myProjects/lianzhiyun/projects/web-projects/platform/src/views/product/pdm/goods/child_info/GoodsInfo.vue","mtime":1565252860544},{"path":"/Users/yuyalong/myProjects/lianzhiyun/projects/web-projects/platform/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuyalong/myProjects/lianzhiyun/projects/web-projects/platform/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/yuyalong/myProjects/lianzhiyun/projects/web-projects/platform/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuyalong/myProjects/lianzhiyun/projects/web-projects/platform/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport Bus from '@/Bus.js'\nimport { mixinBasic, mixinIsEdit } from '@/components/tools/mixin/mixin'\nimport { postBomAndCraftPrices } from '../basic_lib/index'\nimport TabTitle from '../other/TabTitle'\nimport TabMallInfo from './tab_mallInfo/TabMallInfo'\n// 产品信息\nimport ProductInfoForm from './tab_goodsInfo/ProductInfoForm'\nimport CustInfoForm from './tab_goodsInfo/CustInfoForm'\nimport ClassAttrForm from './tab_goodsInfo/ClassAttrForm'\nimport SpringAttrForm from './tab_goodsInfo/SpringAttrForm'\nimport ProductUpload from '@/components/upload/Upload'\nimport CraftInfo from './tab_goodsInfo/craft_info/CraftInfo'\nimport BomInfo from './tab_goodsInfo/bom_info/BomInfo'\n\n// 报价\nimport PriceTab from './tab_price/PriceTab'\n\n// index\nimport {\n  goodsSkuAdd,\n  goodsSkuUpload,\n  bomDelete,\n  setBomAndCraft\n} from '../basic_lib/index'\n\nexport default {\n  name: 'GoodsInfo',\n  mixins: [mixinBasic, mixinIsEdit],\n  data() {\n    return {\n      isLabelColor: false,\n      getSpringType: false,\n      getClassType: false,\n      springVal: undefined,\n      classAttrVal: [],\n      bomButton: false,\n      skuId: '',\n      type: undefined,\n      // 产品详情data\n      skuData: {},\n      // Pic详情\n      pics: [],\n      // 客户详情\n      custInfo: {},\n      // 弹簧详情\n      springInfo: {},\n      // 分类属性\n      attrVals: [],\n      // 工艺详情\n      crafts: [],\n      // BOM详情\n      materialsGroup: [],\n      // 产品详情回显\n      skuInfoData: {},\n      classCatObjId: [],\n      // 客户详情回显\n      custInfoData: {},\n      custName: '',\n      // 弹簧属性回显\n      springInfoData: {},\n      // 产品图片回显\n      picInfoData: [],\n      // 分类属性回显\n      classAttrInfoData: [],\n      classCatId: '',\n      // 工艺详情回显\n      craftsInfoData: [],\n      // 原材料详情回西显\n      materialsGroupInfoData: [],\n      checkedSwitch: false,\n      setSkuId: '',\n      activeTab: '1',\n      subTitle: '保存',\n      getPrice: '',\n      getSpriceData: []\n    }\n  },\n  props: {\n    goodsViewInfo: {\n      type: Object,\n      default: {},\n      required: false\n    }\n  },\n  created() {\n    // 编辑 || 取消\n    Bus.$on('isDisabled', val => {\n      // Input选中\n      const edit = new Promise(resolved => {\n        this.disabled = !val\n        this.isLabelColor = !this.isLabelColor\n        this.custInfoData\n          ? (this.checkedSwitch = true)\n          : (this.checkedSwitch = false)\n        resolved()\n      })\n      edit.then(() => {\n        if (this.disabled) {\n          this.setFormData()\n        }\n      })\n    })\n    Bus.$on('activeTab', val => {\n      this.activeTab = val\n      if (this.activeTab === '1') {\n        this.subTitle = '保存'\n      }\n      if (this.activeTab === '3') {\n        this.subTitle = '提交'\n      }\n    })\n  },\n  mounted() {\n    Bus.$on('setBomButton', val => {\n      this.bomButton = val\n    })\n    Bus.$on('basicInfo', val => {\n      this.skuId = val.skuId\n      this.type = val.type\n    })\n  },\n  destroyed() {\n    Bus.$off('isDisabled')\n    Bus.$off('basicInfo')\n    Bus.$off('activeTab')\n    Bus.$off('setBomButton')\n  },\n  methods: {\n    // 公司上级分类\n    onChangeCategoryName(value) {\n      // console.log(value)\n    },\n    // 基础报价\n    basicSprice(val) {\n      this.getPrice = val\n    },\n    // 价目表\n    spriceData(val) {\n      this.getSpriceData = val\n    },\n    // 提交\n    onSubmit(e) {\n      e.preventDefault()\n      if (this.activeTab === '1') {\n        // 工艺详情\n        const materialsGroup = []\n        this.materialsGroup.forEach((item, index) => {\n          materialsGroup[index] = {\n            bomType: item.bomType,\n            defaultMaterials: item.defaultMaterials,\n            groupName: item.inputVal,\n            materials: item.dataSource.map(item => {\n              return {\n                cost: item.dosage,\n                materialId: item.key,\n                materialUnit: item.unit\n              }\n            })\n          }\n        })\n        this.getFormData().then(() => {\n          const params = {\n            sku: {\n              ...this.skuData,\n              catId: this.skuData.catId\n                ? this.skuData.catId.slice(-1).join('')\n                : '',\n              skuType: 'SPRING'\n            },\n            pics: [...this.pics],\n            custInfo: {\n              ...this.custInfo\n            },\n            springInfo: {\n              springType: this.springVal,\n              ...this.springInfo\n            },\n            attrVals: [...this.attrVals],\n            crafts: this.crafts.map(item => {\n              return {\n                productCraftCode: item.productCraftCode,\n                productCraftId: item.productCraftId,\n                defaultCraft: item.defaultCraft,\n                productCraftName: item.inputVal\n              }\n            }),\n            materialsGroup: [...materialsGroup]\n          }\n          // console.log(params)\n          // 添加商品列表\n          goodsSkuAdd.call(this, params)\n        })\n        return\n      }\n      if (this.activeTab === '3') {\n        postBomAndCraftPrices(\n          this.setSkuId,\n          this.getPrice,\n          this.getSpriceData\n        ).then(res => {\n          if (res.data.code === 0) {\n            this.loading = false\n            this.$message.success('修改成功')\n            this.$emit('isDrawer', false)\n            return false\n          }\n          this.$message.error(res.data.msg)\n          this.$emit('isDrawer', true)\n          this.loading = false\n        })\n      }\n    },\n    // 保存修改\n    onSave(e) {\n      e.preventDefault()\n      if (this.activeTab === '1') {\n        // 工艺详情\n        const materialsGroup = []\n        // console.log(this.materialsGroup)\n        this.materialsGroup.forEach((item, index) => {\n          materialsGroup[index] = {\n            ...item,\n            bomType: item.bomType,\n            defaultMaterials: item.defaultMaterials,\n            groupName: item.inputVal,\n            materials: item.dataSource.map(item => {\n              return {\n                id: item.id,\n                cost: item.dosage,\n                materialId: item.key,\n                materialUnit: item.unit\n              }\n            })\n          }\n          delete materialsGroup[index].dataSource\n          delete materialsGroup[index].skuMaterials\n        })\n        // console.log(this.materialsGroup)\n        // 保存\n        if (this.type === undefined) {\n          this.getFormData().then(() => {\n            const params = {\n              sku: Object.assign(this.skuInfoData, {\n                ...this.skuData,\n                catId: this.skuData.catId\n                  ? this.skuData.catId.slice(-1).join('')\n                  : '',\n                skuType: 'SPRING'\n              }),\n              pics: [...this.pics],\n              custInfo: Object.assign(this.custInfoData || {}, {\n                ...this.custInfo,\n                custId: this.custInfo.custId ? this.custInfo.custId : ''\n              }),\n              springInfo: Object.assign(this.springInfoData || {}, {\n                springType: this.springVal,\n                ...this.springInfo\n              }),\n              attrVals: [...this.attrVals],\n              crafts: this.crafts.map(item => {\n                return {\n                  ...item,\n                  productCraftCode: item.productCraftCode,\n                  productCraftId: item.productCraftId,\n                  defaultCraft: item.defaultCraft,\n                  productCraftName: item.inputVal\n                }\n              }),\n              materialsGroup: [...materialsGroup]\n            }\n            // console.log(params)\n            // 添加商品列表\n            goodsSkuUpload.call(this, params)\n          })\n          return\n        }\n        // 设置工艺和BOM\n        if (this.type === 0) {\n          // 保存\n          const params = {\n            crafts: this.crafts.map(item => {\n              return {\n                productCraftCode: item.productCraftCode,\n                productCraftId: item.productCraftId,\n                defaultCraft: item.defaultCraft,\n                productCraftName: item.inputVal\n              }\n            }),\n            materialsGroup: [...materialsGroup],\n            basePrice: this.price,\n            skuId: this.skuId\n          }\n          // console.log(params)\n          // 添加商品列表\n          setBomAndCraft.call(this, params)\n          return\n        }\n        // 选择工艺和BOM\n        if (this.type === 1) {\n          const data = []\n          const materialsGroup = this.materialsGroup.filter(\n            item => item.defaultMaterials === true\n          )[0]\n          const crafts = this.crafts.filter(\n            item => item.defaultCraft === true\n          )[0]\n          if (materialsGroup) {\n            data.push({\n              defaultMaterials: true,\n              groupName: materialsGroup.groupName,\n              id: materialsGroup.id\n            })\n          }\n          if (crafts) {\n            data.push({\n              defaultCraft: true,\n              inputVal: crafts.inputVal,\n              id: crafts.id\n            })\n          }\n          this.loading = false\n          this.$message.success('设置成功')\n          this.$emit('isDrawer', false)\n          this.$emit('setDispatchInfo', data)\n        }\n      }\n      if (this.activeTab === '3') {\n        postBomAndCraftPrices(\n          this.setSkuId,\n          this.getPrice,\n          this.getSpriceData\n        ).then(res => {\n          if (res.data.code === 0) {\n            this.loading = false\n            this.$message.success('修改成功')\n            this.$emit('isDrawer', false)\n            return false\n          }\n          this.$message.error(res.data.msg)\n          this.$emit('isDrawer', true)\n          this.loading = false\n        })\n      }\n    },\n    // 客户详情switch\n    onChangeCustInfo(value) {\n      this.checkedSwitch = value\n    },\n    // 删除\n    isDelete(val) {\n      bomDelete.call(this, this.goodsViewInfo.sku.id)\n    },\n    // 子组件分类属性 $emit\n    classAttrInfo(val) {\n      if (val.length) {\n        this.getClassType = true\n        this.classAttrVal = val\n        return\n      }\n      this.getClassType = false\n    },\n    // 子组件分类属性 接受data $emit\n    classData(val) {\n      // console.log(val)\n      this.attrVals = val\n    },\n    // 弹簧种类 $emit\n    springType(val) {\n      // console.log(val)\n      if (val === undefined) {\n        this.getSpringType = false\n        this.springVal = undefined\n        return\n      }\n      this.springVal = val\n      this.getSpringType = true\n    },\n    // Upload\n    propsFileList(val) {\n      this.pics = val\n    },\n    // 产品类别非0选中\n    changeSpringType(val) {\n      this.getSpringType = false\n      // console.log(val)\n    },\n    // 工艺详情Data\n    craftData(val) {\n      this.crafts = [...val]\n    },\n    // BOM详情\n    bomData(val) {\n      this.materialsGroup = [...val]\n    },\n    // 产品详情子组件接受分类属性ID数组\n    classCatObj(val) {\n      this.classCatObjId = val.id\n    },\n    // FormData\n    async getFormData() {\n      // 产品详情FormData\n      this.$refs.goodsInfoForm.goodsInfoForm.validateFields((err, values) => {\n        if (!err) {\n          // console.log(values)\n          this.skuData = values\n        }\n      })\n      // 客户详情FormData\n      if (this.$refs.custInfoForm) {\n        this.$refs.custInfoForm.custInfoForm.validateFields((err, values) => {\n          if (!err) {\n            // console.log(values)\n            this.custInfo = values\n          }\n        })\n      }\n      // 分类属性FormData\n      if (this.$refs.classAttrForm) {\n        this.$refs.classAttrForm.classAttrInfoForm.validateFields(\n          (err, values) => {\n            if (!err) {\n              // console.log(values)\n            }\n          }\n        )\n      }\n      // 弹簧属性FormData\n      if (this.$refs.productAttrForm) {\n        this.$refs.productAttrForm.productAttrForm.validateFields(\n          (err, values) => {\n            if (!err) {\n              // console.log(values)\n              this.springInfo = values\n            }\n          }\n        )\n      }\n    },\n    // Form详情\n    async setFormData() {\n      // 产品详情FormData\n      this.$refs.goodsInfoForm.goodsInfoForm.setFieldsValue({\n        catId: this.classCatObjId,\n        name: this.skuInfoData.name,\n        cz: this.skuInfoData.cz,\n        drawNum: this.skuInfoData.drawNum,\n        drawVersion: this.skuInfoData.drawVersion,\n        spec: this.skuInfoData.spec,\n        unit: this.skuInfoData.unit || '只',\n        gateway: this.skuInfoData.gateway,\n        standard: this.skuInfoData.standard,\n        weight: this.skuInfoData.weight + '' || undefined,\n        remark: this.skuInfoData.remark,\n        bmcl: this.skuInfoData.bmcl,\n        productSpringType: this.springInfoData.springType\n      })\n      // 客户详情FormData\n      this.$refs.custInfoForm &&\n        this.$refs.custInfoForm.custInfoForm.setFieldsValue({\n          custId: this.custInfoData ? this.custInfoData.custId : undefined,\n          custDrawNum: this.custInfoData ? this.custInfoData.custDrawNum : '',\n          custDrawVersion: this.custInfoData\n            ? this.custInfoData.custDrawVersion\n            : '',\n          custSkuCode: this.custInfoData ? this.custInfoData.custSkuCode : '',\n          custMaterialNum: this.custInfoData\n            ? this.custInfoData.custMaterialNum\n            : '',\n          custMaterialName: this.custInfoData\n            ? this.custInfoData.custMaterialName\n            : '',\n          custCz: this.custInfoData ? this.custInfoData.custCz : '',\n          custBmcl: this.custInfoData ? this.custInfoData.custBmcl : '',\n          custSkuSpec: this.custInfoData ? this.custInfoData.custSkuSpec : '',\n          custRemark: this.custInfoData ? this.custInfoData.custRemark : ''\n        })\n      // 弹簧属性FormData\n      this.$refs.productAttrForm &&\n        this.$refs.productAttrForm.productAttrForm.setFieldsValue({\n          gcdj: this.springInfoData.gcdj,\n          xj: this.springInfoData.xj + '',\n          wj: this.springInfoData.wj + '',\n          zygd: this.springInfoData.zygd + '',\n          zqs: this.springInfoData.zqs + '',\n          cz: this.springInfoData.cz,\n          ybgd: this.springInfoData.ybgd + '',\n          gzgd: this.springInfoData.gzgd + '',\n          yxqs: this.springInfoData.yxqs + '',\n          lz: this.springInfoData.lz + '',\n          xx: this.springInfoData.xx,\n          lxj: this.springInfoData.lxj + '',\n          zkcd: this.springInfoData.zkcd + '',\n          nj: this.springInfoData.nj + '',\n          hd: this.springInfoData.hd + '',\n          bs: this.springInfoData.bs + '',\n          cs: this.springInfoData.cs + '',\n          yl: this.springInfoData.yl + '',\n          gd: this.springInfoData.gd + '',\n          zdbxl: this.springInfoData.zdbxl + '',\n          xrb: this.springInfoData.xrb + ''\n        })\n    }\n  },\n  watch: {\n    goodsViewInfo: {\n      handler(val) {\n        // console.log(val)\n        if (Object.keys(val).length) {\n          // sku\n          this.skuInfoData = val.sku\n          this.setSkuId = this.skuInfoData.id\n          // cust\n          this.custInfoData = val.custInfo || null\n          val.custInfo\n            ? (this.checkedSwitch = true)\n            : (this.checkedSwitch = false)\n          // custName\n          this.custName = val.cust ? val.cust.custShortName : undefined\n          // spring\n          this.springInfoData = val.springInfo || {}\n          // springType\n          this.springVal = val.springInfo\n            ? val.springInfo.springType\n            : undefined\n          // PIC\n          this.picInfoData = val.pics\n          // 分类属性\n          this.classAttrInfoData = val.attrVals\n          this.classCatId = val.sku.catId\n          // 工艺详情\n          this.craftsInfoData = val.crafts\n          // 原材料\n          this.materialsGroupInfoData = val.materialsGroup || []\n        }\n      },\n      deep: true,\n      immediate: true\n    }\n  },\n  computed: {\n    getDetailPermission() {\n      return this.$store.state.detailPermission\n    }\n  },\n  components: {\n    'tab-title': TabTitle,\n    'tabMall-info': TabMallInfo,\n    'product-info': ProductInfoForm,\n    'cust-info': CustInfoForm,\n    'class-attr': ClassAttrForm,\n    'spring-attr': SpringAttrForm,\n    'product-upload': ProductUpload,\n    'craft-info': CraftInfo,\n    'bom-info': BomInfo,\n    'price-info': PriceTab\n  }\n}\n",{"version":3,"sources":["GoodsInfo.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAgJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"GoodsInfo.vue","sourceRoot":"src/views/product/pdm/goods/child_info","sourcesContent":["<template>\n  <div class=\"goods-info\">\n    <tab-title @isDelete=\"isDelete\">\n      <template v-slot:tabGoodsInfo>\n        <!-- 产品信息 -->\n        <a-row>\n          <a-col :span=\"24\">\n            <h3 class=\"categoryInfo-title\">产品详情</h3>\n          </a-col>\n          <a-col :span=\"24\">\n            <product-info\n              ref=\"goodsInfoForm\"\n              @springType=\"springType\"\n              @changeSpringType=\"changeSpringType\"\n              @classAttrInfo=\"classAttrInfo\"\n              @classCatObj=\"classCatObj\"\n              :skuInfoData=\"skuInfoData\"\n              :childDisabled=\"disabled\"\n              :springInfoType=\"springInfoData.springType\"\n            />\n          </a-col>\n          <a-col :span=\"24\">\n            <a-col :span=\"24\">\n              <h3 class=\"categoryInfo-title\" style=\"display: inline-block; margin-right: 10px;\">客户详情</h3>\n              <a-switch\n                checkedChildren=\"可选\"\n                unCheckedChildren=\"隐藏\"\n                :disabled=\"!disabled\"\n                size=\"small\"\n                :checked=\"checkedSwitch\"\n                @change=\"onChangeCustInfo\"\n              />\n            </a-col>\n            <a-col :span=\"24\">\n              <cust-info\n                v-if=\"checkedSwitch\"\n                ref=\"custInfoForm\"\n                :custInfoData=\"custInfoData\"\n                :childDisabled=\"disabled\"\n                :custName=\"custName\"\n              />\n            </a-col>\n          </a-col>\n          <a-col :span=\"24\" v-if=\"getClassType || classAttrInfoData.length\">\n            <a-col :span=\"24\">\n              <h3 class=\"categoryInfo-title\">分类属性</h3>\n            </a-col>\n            <a-col :span=\"24\">\n              <class-attr\n                ref=\"classAttrForm\"\n                @classData=\"classData\"\n                :classAttrVal=\"classAttrVal\"\n                :childDisabled=\"disabled\"\n                :classAttrInfoData=\"classAttrInfoData\"\n                :classCatId=\"classCatId\"\n              />\n            </a-col>\n          </a-col>\n          <a-col :span=\"24\" v-if=\"getSpringType || springVal !== undefined\">\n            <a-col :span=\"24\">\n              <h3 class=\"categoryInfo-title\">弹簧属性</h3>\n            </a-col>\n            <a-col :span=\"24\">\n              <spring-attr\n                ref=\"productAttrForm\"\n                :springVal=\"springVal\"\n                :childDisabled=\"disabled\"\n                :springInfoData=\"springInfoData\"\n              />\n            </a-col>\n          </a-col>\n          <a-col :span=\"24\">\n            <a-col :span=\"24\">\n              <h3 class=\"categoryInfo-title\">产品图片</h3>\n            </a-col>\n            <a-col :span=\"24\">\n              <product-upload @propsFileList=\"propsFileList\" :picInfoData=\"picInfoData\" />\n            </a-col>\n          </a-col>\n          <a-col :span=\"24\">\n            <a-col :span=\"24\">\n              <h3 class=\"categoryInfo-title\">工艺详情</h3>\n            </a-col>\n            <a-col :span=\"24\">\n              <craft-info\n                @craftData=\"craftData\"\n                :childDisabled=\"disabled\"\n                :craftsInfoData=\"craftsInfoData\"\n              />\n            </a-col>\n          </a-col>\n          <a-col :span=\"24\">\n            <a-col :span=\"24\">\n              <h3 class=\"categoryInfo-title\">BOM详情</h3>\n            </a-col>\n            <a-col :span=\"24\">\n              <bom-info\n                @bomData=\"bomData\"\n                :childDisabled=\"disabled\"\n                :materialsGroupInfoData=\"materialsGroupInfoData\"\n              />\n            </a-col>\n          </a-col>\n        </a-row>\n      </template>\n      <template v-slot:tabMallAttr>\n        <tabMall-info />\n      </template>\n      <template v-slot:PriceTab>\n        <price-info :skuId=\"setSkuId\" @basicSprice=\"basicSprice\" @spriceData=\"spriceData\" />\n      </template>\n    </tab-title>\n    <div\n      :style=\"{\n          position: 'absolute',\n          left: 0,\n          bottom: 0,\n          width: '100%',\n          borderTop: '1px solid #E9E9E9',\n          padding: '10px 16px',\n          background: '#FFF',\n          textAlign: 'right',\n          zIndex: 100\n        }\"\n    >\n      <a-button :style=\"{marginRight: '8px'}\" @click=\"onClose\">取消</a-button>\n      <a-button\n        @click=\"onSubmit\"\n        type=\"primary\"\n        :loading=\"loading\"\n        v-if=\"isEdit&&!bomButton\"\n      >{{ subTitle }}</a-button>\n      <a-button\n        @click=\"onSave\"\n        type=\"primary\"\n        :disabled=\"!disabled\"\n        :loading=\"loading\"\n        v-else-if=\"getDetailPermission.includes('UPDATE')&&!bomButton\"\n      >保存</a-button>\n      <a-button @click=\"onSave\" type=\"primary\" :loading=\"loading\" v-else-if=\"bomButton\">保存</a-button>\n    </div>\n  </div>\n</template>\n<script>\nimport Bus from '@/Bus.js'\nimport { mixinBasic, mixinIsEdit } from '@/components/tools/mixin/mixin'\nimport { postBomAndCraftPrices } from '../basic_lib/index'\nimport TabTitle from '../other/TabTitle'\nimport TabMallInfo from './tab_mallInfo/TabMallInfo'\n// 产品信息\nimport ProductInfoForm from './tab_goodsInfo/ProductInfoForm'\nimport CustInfoForm from './tab_goodsInfo/CustInfoForm'\nimport ClassAttrForm from './tab_goodsInfo/ClassAttrForm'\nimport SpringAttrForm from './tab_goodsInfo/SpringAttrForm'\nimport ProductUpload from '@/components/upload/Upload'\nimport CraftInfo from './tab_goodsInfo/craft_info/CraftInfo'\nimport BomInfo from './tab_goodsInfo/bom_info/BomInfo'\n\n// 报价\nimport PriceTab from './tab_price/PriceTab'\n\n// index\nimport {\n  goodsSkuAdd,\n  goodsSkuUpload,\n  bomDelete,\n  setBomAndCraft\n} from '../basic_lib/index'\n\nexport default {\n  name: 'GoodsInfo',\n  mixins: [mixinBasic, mixinIsEdit],\n  data() {\n    return {\n      isLabelColor: false,\n      getSpringType: false,\n      getClassType: false,\n      springVal: undefined,\n      classAttrVal: [],\n      bomButton: false,\n      skuId: '',\n      type: undefined,\n      // 产品详情data\n      skuData: {},\n      // Pic详情\n      pics: [],\n      // 客户详情\n      custInfo: {},\n      // 弹簧详情\n      springInfo: {},\n      // 分类属性\n      attrVals: [],\n      // 工艺详情\n      crafts: [],\n      // BOM详情\n      materialsGroup: [],\n      // 产品详情回显\n      skuInfoData: {},\n      classCatObjId: [],\n      // 客户详情回显\n      custInfoData: {},\n      custName: '',\n      // 弹簧属性回显\n      springInfoData: {},\n      // 产品图片回显\n      picInfoData: [],\n      // 分类属性回显\n      classAttrInfoData: [],\n      classCatId: '',\n      // 工艺详情回显\n      craftsInfoData: [],\n      // 原材料详情回西显\n      materialsGroupInfoData: [],\n      checkedSwitch: false,\n      setSkuId: '',\n      activeTab: '1',\n      subTitle: '保存',\n      getPrice: '',\n      getSpriceData: []\n    }\n  },\n  props: {\n    goodsViewInfo: {\n      type: Object,\n      default: {},\n      required: false\n    }\n  },\n  created() {\n    // 编辑 || 取消\n    Bus.$on('isDisabled', val => {\n      // Input选中\n      const edit = new Promise(resolved => {\n        this.disabled = !val\n        this.isLabelColor = !this.isLabelColor\n        this.custInfoData\n          ? (this.checkedSwitch = true)\n          : (this.checkedSwitch = false)\n        resolved()\n      })\n      edit.then(() => {\n        if (this.disabled) {\n          this.setFormData()\n        }\n      })\n    })\n    Bus.$on('activeTab', val => {\n      this.activeTab = val\n      if (this.activeTab === '1') {\n        this.subTitle = '保存'\n      }\n      if (this.activeTab === '3') {\n        this.subTitle = '提交'\n      }\n    })\n  },\n  mounted() {\n    Bus.$on('setBomButton', val => {\n      this.bomButton = val\n    })\n    Bus.$on('basicInfo', val => {\n      this.skuId = val.skuId\n      this.type = val.type\n    })\n  },\n  destroyed() {\n    Bus.$off('isDisabled')\n    Bus.$off('basicInfo')\n    Bus.$off('activeTab')\n    Bus.$off('setBomButton')\n  },\n  methods: {\n    // 公司上级分类\n    onChangeCategoryName(value) {\n      // console.log(value)\n    },\n    // 基础报价\n    basicSprice(val) {\n      this.getPrice = val\n    },\n    // 价目表\n    spriceData(val) {\n      this.getSpriceData = val\n    },\n    // 提交\n    onSubmit(e) {\n      e.preventDefault()\n      if (this.activeTab === '1') {\n        // 工艺详情\n        const materialsGroup = []\n        this.materialsGroup.forEach((item, index) => {\n          materialsGroup[index] = {\n            bomType: item.bomType,\n            defaultMaterials: item.defaultMaterials,\n            groupName: item.inputVal,\n            materials: item.dataSource.map(item => {\n              return {\n                cost: item.dosage,\n                materialId: item.key,\n                materialUnit: item.unit\n              }\n            })\n          }\n        })\n        this.getFormData().then(() => {\n          const params = {\n            sku: {\n              ...this.skuData,\n              catId: this.skuData.catId\n                ? this.skuData.catId.slice(-1).join('')\n                : '',\n              skuType: 'SPRING'\n            },\n            pics: [...this.pics],\n            custInfo: {\n              ...this.custInfo\n            },\n            springInfo: {\n              springType: this.springVal,\n              ...this.springInfo\n            },\n            attrVals: [...this.attrVals],\n            crafts: this.crafts.map(item => {\n              return {\n                productCraftCode: item.productCraftCode,\n                productCraftId: item.productCraftId,\n                defaultCraft: item.defaultCraft,\n                productCraftName: item.inputVal\n              }\n            }),\n            materialsGroup: [...materialsGroup]\n          }\n          // console.log(params)\n          // 添加商品列表\n          goodsSkuAdd.call(this, params)\n        })\n        return\n      }\n      if (this.activeTab === '3') {\n        postBomAndCraftPrices(\n          this.setSkuId,\n          this.getPrice,\n          this.getSpriceData\n        ).then(res => {\n          if (res.data.code === 0) {\n            this.loading = false\n            this.$message.success('修改成功')\n            this.$emit('isDrawer', false)\n            return false\n          }\n          this.$message.error(res.data.msg)\n          this.$emit('isDrawer', true)\n          this.loading = false\n        })\n      }\n    },\n    // 保存修改\n    onSave(e) {\n      e.preventDefault()\n      if (this.activeTab === '1') {\n        // 工艺详情\n        const materialsGroup = []\n        // console.log(this.materialsGroup)\n        this.materialsGroup.forEach((item, index) => {\n          materialsGroup[index] = {\n            ...item,\n            bomType: item.bomType,\n            defaultMaterials: item.defaultMaterials,\n            groupName: item.inputVal,\n            materials: item.dataSource.map(item => {\n              return {\n                id: item.id,\n                cost: item.dosage,\n                materialId: item.key,\n                materialUnit: item.unit\n              }\n            })\n          }\n          delete materialsGroup[index].dataSource\n          delete materialsGroup[index].skuMaterials\n        })\n        // console.log(this.materialsGroup)\n        // 保存\n        if (this.type === undefined) {\n          this.getFormData().then(() => {\n            const params = {\n              sku: Object.assign(this.skuInfoData, {\n                ...this.skuData,\n                catId: this.skuData.catId\n                  ? this.skuData.catId.slice(-1).join('')\n                  : '',\n                skuType: 'SPRING'\n              }),\n              pics: [...this.pics],\n              custInfo: Object.assign(this.custInfoData || {}, {\n                ...this.custInfo,\n                custId: this.custInfo.custId ? this.custInfo.custId : ''\n              }),\n              springInfo: Object.assign(this.springInfoData || {}, {\n                springType: this.springVal,\n                ...this.springInfo\n              }),\n              attrVals: [...this.attrVals],\n              crafts: this.crafts.map(item => {\n                return {\n                  ...item,\n                  productCraftCode: item.productCraftCode,\n                  productCraftId: item.productCraftId,\n                  defaultCraft: item.defaultCraft,\n                  productCraftName: item.inputVal\n                }\n              }),\n              materialsGroup: [...materialsGroup]\n            }\n            // console.log(params)\n            // 添加商品列表\n            goodsSkuUpload.call(this, params)\n          })\n          return\n        }\n        // 设置工艺和BOM\n        if (this.type === 0) {\n          // 保存\n          const params = {\n            crafts: this.crafts.map(item => {\n              return {\n                productCraftCode: item.productCraftCode,\n                productCraftId: item.productCraftId,\n                defaultCraft: item.defaultCraft,\n                productCraftName: item.inputVal\n              }\n            }),\n            materialsGroup: [...materialsGroup],\n            basePrice: this.price,\n            skuId: this.skuId\n          }\n          // console.log(params)\n          // 添加商品列表\n          setBomAndCraft.call(this, params)\n          return\n        }\n        // 选择工艺和BOM\n        if (this.type === 1) {\n          const data = []\n          const materialsGroup = this.materialsGroup.filter(\n            item => item.defaultMaterials === true\n          )[0]\n          const crafts = this.crafts.filter(\n            item => item.defaultCraft === true\n          )[0]\n          if (materialsGroup) {\n            data.push({\n              defaultMaterials: true,\n              groupName: materialsGroup.groupName,\n              id: materialsGroup.id\n            })\n          }\n          if (crafts) {\n            data.push({\n              defaultCraft: true,\n              inputVal: crafts.inputVal,\n              id: crafts.id\n            })\n          }\n          this.loading = false\n          this.$message.success('设置成功')\n          this.$emit('isDrawer', false)\n          this.$emit('setDispatchInfo', data)\n        }\n      }\n      if (this.activeTab === '3') {\n        postBomAndCraftPrices(\n          this.setSkuId,\n          this.getPrice,\n          this.getSpriceData\n        ).then(res => {\n          if (res.data.code === 0) {\n            this.loading = false\n            this.$message.success('修改成功')\n            this.$emit('isDrawer', false)\n            return false\n          }\n          this.$message.error(res.data.msg)\n          this.$emit('isDrawer', true)\n          this.loading = false\n        })\n      }\n    },\n    // 客户详情switch\n    onChangeCustInfo(value) {\n      this.checkedSwitch = value\n    },\n    // 删除\n    isDelete(val) {\n      bomDelete.call(this, this.goodsViewInfo.sku.id)\n    },\n    // 子组件分类属性 $emit\n    classAttrInfo(val) {\n      if (val.length) {\n        this.getClassType = true\n        this.classAttrVal = val\n        return\n      }\n      this.getClassType = false\n    },\n    // 子组件分类属性 接受data $emit\n    classData(val) {\n      // console.log(val)\n      this.attrVals = val\n    },\n    // 弹簧种类 $emit\n    springType(val) {\n      // console.log(val)\n      if (val === undefined) {\n        this.getSpringType = false\n        this.springVal = undefined\n        return\n      }\n      this.springVal = val\n      this.getSpringType = true\n    },\n    // Upload\n    propsFileList(val) {\n      this.pics = val\n    },\n    // 产品类别非0选中\n    changeSpringType(val) {\n      this.getSpringType = false\n      // console.log(val)\n    },\n    // 工艺详情Data\n    craftData(val) {\n      this.crafts = [...val]\n    },\n    // BOM详情\n    bomData(val) {\n      this.materialsGroup = [...val]\n    },\n    // 产品详情子组件接受分类属性ID数组\n    classCatObj(val) {\n      this.classCatObjId = val.id\n    },\n    // FormData\n    async getFormData() {\n      // 产品详情FormData\n      this.$refs.goodsInfoForm.goodsInfoForm.validateFields((err, values) => {\n        if (!err) {\n          // console.log(values)\n          this.skuData = values\n        }\n      })\n      // 客户详情FormData\n      if (this.$refs.custInfoForm) {\n        this.$refs.custInfoForm.custInfoForm.validateFields((err, values) => {\n          if (!err) {\n            // console.log(values)\n            this.custInfo = values\n          }\n        })\n      }\n      // 分类属性FormData\n      if (this.$refs.classAttrForm) {\n        this.$refs.classAttrForm.classAttrInfoForm.validateFields(\n          (err, values) => {\n            if (!err) {\n              // console.log(values)\n            }\n          }\n        )\n      }\n      // 弹簧属性FormData\n      if (this.$refs.productAttrForm) {\n        this.$refs.productAttrForm.productAttrForm.validateFields(\n          (err, values) => {\n            if (!err) {\n              // console.log(values)\n              this.springInfo = values\n            }\n          }\n        )\n      }\n    },\n    // Form详情\n    async setFormData() {\n      // 产品详情FormData\n      this.$refs.goodsInfoForm.goodsInfoForm.setFieldsValue({\n        catId: this.classCatObjId,\n        name: this.skuInfoData.name,\n        cz: this.skuInfoData.cz,\n        drawNum: this.skuInfoData.drawNum,\n        drawVersion: this.skuInfoData.drawVersion,\n        spec: this.skuInfoData.spec,\n        unit: this.skuInfoData.unit || '只',\n        gateway: this.skuInfoData.gateway,\n        standard: this.skuInfoData.standard,\n        weight: this.skuInfoData.weight + '' || undefined,\n        remark: this.skuInfoData.remark,\n        bmcl: this.skuInfoData.bmcl,\n        productSpringType: this.springInfoData.springType\n      })\n      // 客户详情FormData\n      this.$refs.custInfoForm &&\n        this.$refs.custInfoForm.custInfoForm.setFieldsValue({\n          custId: this.custInfoData ? this.custInfoData.custId : undefined,\n          custDrawNum: this.custInfoData ? this.custInfoData.custDrawNum : '',\n          custDrawVersion: this.custInfoData\n            ? this.custInfoData.custDrawVersion\n            : '',\n          custSkuCode: this.custInfoData ? this.custInfoData.custSkuCode : '',\n          custMaterialNum: this.custInfoData\n            ? this.custInfoData.custMaterialNum\n            : '',\n          custMaterialName: this.custInfoData\n            ? this.custInfoData.custMaterialName\n            : '',\n          custCz: this.custInfoData ? this.custInfoData.custCz : '',\n          custBmcl: this.custInfoData ? this.custInfoData.custBmcl : '',\n          custSkuSpec: this.custInfoData ? this.custInfoData.custSkuSpec : '',\n          custRemark: this.custInfoData ? this.custInfoData.custRemark : ''\n        })\n      // 弹簧属性FormData\n      this.$refs.productAttrForm &&\n        this.$refs.productAttrForm.productAttrForm.setFieldsValue({\n          gcdj: this.springInfoData.gcdj,\n          xj: this.springInfoData.xj + '',\n          wj: this.springInfoData.wj + '',\n          zygd: this.springInfoData.zygd + '',\n          zqs: this.springInfoData.zqs + '',\n          cz: this.springInfoData.cz,\n          ybgd: this.springInfoData.ybgd + '',\n          gzgd: this.springInfoData.gzgd + '',\n          yxqs: this.springInfoData.yxqs + '',\n          lz: this.springInfoData.lz + '',\n          xx: this.springInfoData.xx,\n          lxj: this.springInfoData.lxj + '',\n          zkcd: this.springInfoData.zkcd + '',\n          nj: this.springInfoData.nj + '',\n          hd: this.springInfoData.hd + '',\n          bs: this.springInfoData.bs + '',\n          cs: this.springInfoData.cs + '',\n          yl: this.springInfoData.yl + '',\n          gd: this.springInfoData.gd + '',\n          zdbxl: this.springInfoData.zdbxl + '',\n          xrb: this.springInfoData.xrb + ''\n        })\n    }\n  },\n  watch: {\n    goodsViewInfo: {\n      handler(val) {\n        // console.log(val)\n        if (Object.keys(val).length) {\n          // sku\n          this.skuInfoData = val.sku\n          this.setSkuId = this.skuInfoData.id\n          // cust\n          this.custInfoData = val.custInfo || null\n          val.custInfo\n            ? (this.checkedSwitch = true)\n            : (this.checkedSwitch = false)\n          // custName\n          this.custName = val.cust ? val.cust.custShortName : undefined\n          // spring\n          this.springInfoData = val.springInfo || {}\n          // springType\n          this.springVal = val.springInfo\n            ? val.springInfo.springType\n            : undefined\n          // PIC\n          this.picInfoData = val.pics\n          // 分类属性\n          this.classAttrInfoData = val.attrVals\n          this.classCatId = val.sku.catId\n          // 工艺详情\n          this.craftsInfoData = val.crafts\n          // 原材料\n          this.materialsGroupInfoData = val.materialsGroup || []\n        }\n      },\n      deep: true,\n      immediate: true\n    }\n  },\n  computed: {\n    getDetailPermission() {\n      return this.$store.state.detailPermission\n    }\n  },\n  components: {\n    'tab-title': TabTitle,\n    'tabMall-info': TabMallInfo,\n    'product-info': ProductInfoForm,\n    'cust-info': CustInfoForm,\n    'class-attr': ClassAttrForm,\n    'spring-attr': SpringAttrForm,\n    'product-upload': ProductUpload,\n    'craft-info': CraftInfo,\n    'bom-info': BomInfo,\n    'price-info': PriceTab\n  }\n}\n</script>\n<style lang=\"less\" scoped>\n@import \"~styles/variable.less\";\n\n.goods-info {\n  .categoryInfo-title {\n    margin: 15px 0;\n    .h3_title();\n  }\n  .labelColor {\n    /deep/ .ant-form-item-label label {\n      .labelColor();\n    }\n  }\n}\n</style>\n"]}]}
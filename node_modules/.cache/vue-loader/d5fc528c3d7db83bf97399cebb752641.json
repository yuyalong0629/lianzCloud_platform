{"remainingRequest":"/Users/yuyalong/myProjects/lianzhiyun/projects/web-projects/platform/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/yuyalong/myProjects/lianzhiyun/projects/web-projects/platform/src/views/factorySale/dispatchOrder/dispatch.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/yuyalong/myProjects/lianzhiyun/projects/web-projects/platform/src/views/factorySale/dispatchOrder/dispatch.vue","mtime":1564139090389},{"path":"/Users/yuyalong/myProjects/lianzhiyun/projects/web-projects/platform/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuyalong/myProjects/lianzhiyun/projects/web-projects/platform/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuyalong/myProjects/lianzhiyun/projects/web-projects/platform/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/yuyalong/myProjects/lianzhiyun/projects/web-projects/platform/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuyalong/myProjects/lianzhiyun/projects/web-projects/platform/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport Bus from '@/Bus.js'\nimport infiniteScroll from 'vue-infinite-scroll'\nimport { postJson, get } from '@/api/axios.js'\nimport api from '@/api/index.js'\nimport moment from 'moment'\nimport dispatchInfo from '@/views/product/pdm/goods/child_info/GoodsInfo'\nimport inputSearch from '@/views/sale/dispatchOrder/other/inputSearch'\nimport { mixinBasic, mixinDrawer } from '@/components/tools/mixin/mixin'\nexport default {\n  directives: { infiniteScroll },\n  mixins: [mixinBasic, mixinDrawer],\n  components: {\n    dispatchInfo,\n    inputSearch\n  },\n  data() {\n    return {\n      companyType: 'FACTORY',\n      dateFormat: 'YYYY-MM-DD',\n      busy: false,\n      loadingCompony: false,\n      dataCompanySize: 0,\n      dataCompany: [],\n      orderMerge: [],\n      currentPage: 1,\n      pageSize: 15,\n      searchTerm: {},\n      updateList: {\n        num: 0,\n        date: ''\n      },\n      companyList: [],\n      submitLoading: false,\n      goodsViewInfo: {},\n      visibleModal: false,\n      selectIndex: '',\n      isModalActive: 0,\n      channelSkuId: ''\n    }\n  },\n  computed: {\n    getMenuPermission() {\n      return this.$store.state.menuPermission\n    }\n  },\n  methods: {\n    moment,\n    // 按条件搜索渠道商订单列表\n    changeInput(val, type) {\n      this.dataCompany = []\n      this.searchTerm = val\n      this.getFactoryOrder()\n    },\n    // 滚动滑动条加载订单\n    handleInfiniteOnLoad() {\n      const data = this.dataCompany\n      this.loadingCompony = true\n      this.busy = true\n      if (data.length >= this.dataCompanySize && this.dataCompanySize !== 0) {\n        this.busy = true\n        this.loadingCompony = false\n      } else {\n        this.getFactoryOrder(this.currentPage)\n        this.busy = false\n        this.loadingCompony = false\n      }\n    },\n    // 移除订单\n    removeItem(id, index) {\n      const _this = this\n      this.$confirm({\n        title: '移除订单信息',\n        content: '您确定要移除这条订单消息吗?',\n        zIndex: 99999,\n        onOk() {\n          postJson(api.delFactoryPolicyOrder, { id }).then(res => {\n            if (res.data.code === 0) {\n              _this.$message.success('订单移除成功')\n              _this.dataCompany.splice(index, 1)\n              _this.dataCompanySize--\n            } else {\n              _this.$message.error(res.data.msg)\n            }\n          })\n        },\n        onCancel() { }\n      })\n    },\n    addCompany(channelSkuId, index, num, date) {\n      this.dispatchAction(channelSkuId, index, num, date)\n    },\n    addLittle(channelSkuId, index) {\n      const updateList = this.updateList\n      this.dispatchAction(channelSkuId, index, updateList.num, updateList.date)\n    },\n    /**\n    * @description 订单分派\n    * @param channelSkuId 产品SkuID 查询产品详情\n    * @param index 当前点击的索引\n    * @description 先判断是否设置制造工艺和BOM\n    * 一、设置。判断是否已经添加过产品。已经有添加的产品则在进行判断规格、材质、制造工艺、BOM是否一致，一致则添加不一致则警告；如果没有添加过产品则直接将 产品添加过去。\n    * 二、未设置。提示用户先设置制造工艺和BOM，确定设置则直接右侧抽屉展开\n    */\n    dispatchAction(channelSkuId, index, num, date) {\n      this.selectIndex = index\n      this.channelSkuId = channelSkuId\n      const dataCompany = this.dataCompany\n      const companyList = this.companyList\n      const item = dataCompany[index]\n      const target = JSON.parse(JSON.stringify(item))\n      const tar = companyList.filter(itm => itm.odRequireDueDate === date)[0]\n      dataCompany[index].clickedVisible = false\n      if (item.bom === null || item.craft === null) {\n        this.visibleModal = true\n        this.channelSkuId = channelSkuId\n        return\n      }\n      if (companyList.length !== 0) {\n        if (item.channelSkuId !== companyList[0].channelSkuId) {\n          this.$message.warning('不同产品不能合并生成工单。')\n          return\n        }\n        if (item.bomGroupId !== companyList[0].bomGroupId || item.craftGroupId !== companyList[0].craftGroupId) {\n          this.$message.warning('不同制造工艺和BOM不能合并生成工单。')\n          return\n        }\n        if (!tar) {\n          this.$message.warning('不同的交期不能合并生成工单')\n          return\n        }\n        const tarList = companyList.filter(itm => itm.id === item.id)[0]\n        if (!tarList) {\n          target.odRequireDueDate = date\n          target.number = num\n          companyList.push(target)\n        } else {\n          tarList.number += num\n        }\n        if (num >= item.number) {\n          dataCompany.splice(index, 1)\n        } else {\n          item.number -= num\n        }\n      } else {\n        target.odRequireDueDate = date\n        target.number = num\n        if (num >= item.number) {\n          dataCompany.splice(index, 1)\n        } else {\n          item.number -= num\n        }\n        companyList.push(target)\n      }\n    },\n    uploadBom(item, index) {\n      this.selectIndex = index\n      this.dataCompany[index].clickedVisible = false\n      this.channelSkuId = item.channelSkuId\n      this.isModalActive = 1\n      this.onModalOk()\n    },\n    // MOdal\n    onModalOk() {\n      this.visibleModal = false\n      this.getViewInfo(this.channelSkuId)\n      this.$store.commit('setPromptTitle', {\n        title: '产品信息',\n        isEdit: true\n      })\n    },\n    onModalNo() {\n      this.visibleModal = false\n    },\n    setDispatchInfo(val) {\n      const dataCompany = this.dataCompany\n      const index = this.selectIndex\n      const bom = val[0]\n      const craft = val[1]\n      const data = {}\n      data.id = dataCompany[index].id\n      data.bomGroupId = bom.id\n      data.craftGroupId = craft.productCraftId\n      postJson(api.updateBomCraft, data).then(res => {\n        if (res.data.code === 0) {\n          dataCompany[index].bom = bom.inputVal\n          dataCompany[index].craft = craft.inputVal\n          this.$message.success('设置工艺和BOM成功')\n          this.visible = false\n        } else {\n          this.$message.error(res.data.msg)\n        }\n      })\n    },\n    // Modal Tabs\n    onModalInfo(key) {\n      this.isModalActive = key\n    },\n    // 删除工厂中的订单\n    minusCompany(index) {\n      if (index >= 0) {\n        const companyList = this.companyList\n        const dataCompany = this.dataCompany\n        const item = companyList[index]\n        const target = dataCompany.filter(itm => itm.id === item.id)[0]\n        if (target) {\n          target.number += item.number\n        } else {\n          dataCompany.push(item)\n          this.dataCompanySize += 1\n        }\n        companyList.splice(index, 1)\n      } else {\n        this.companyList = []\n        this.dataCompany = []\n        this.getFactoryOrder()\n      }\n    },\n    // 获取工厂订单列表\n    getFactoryOrder(currentPage = 1, pageSize = 15) {\n      const data = this.searchTerm\n      data.currentPage = currentPage\n      data.pageSize = pageSize\n      postJson(api.getFactoryPolicyOrder, data).then(res => {\n        if (res.data.code === 0) {\n          const data = res.data.data.records\n          this.dataCompanySize = Number(res.data.data.total)\n          if (data.length) {\n            data.forEach(item => {\n              item.clickedVisible = false\n            })\n            this.dataCompany = this.dataCompany.concat(data)\n          }\n          this.currentPage += 1\n        }\n      }).catch(() => {\n        this.$message.error('系统错误')\n      })\n    },\n    updataDes(e, num, data, index) {\n      window.event ? window.event.cancelBubble = true : e.stopPropagation()\n      const updateList = this.updateList\n      updateList.num = num\n      updateList.date = data\n      this.dataCompany[index].clickedVisible = true\n    },\n    updateTime(dates, dateStrings) {\n      this.updateList.date = dateStrings\n    },\n    // 订单分派提交\n    submit() {\n      if (this.companyList.length === 0) {\n        return\n      }\n      this.submitLoading = true\n      const list = []\n      var totalNumber = null\n      var odRequireDueDate = null\n      this.companyList.forEach(item => {\n        list.push({\n          id: item.id,\n          number: item.number\n        })\n        totalNumber += item.number\n        odRequireDueDate = item.odRequireDueDate\n      })\n      postJson(api.putFactoryPolicyOrderAdd, {\n        list,\n        totalNumber: totalNumber,\n        odRequireDueDate: odRequireDueDate,\n        remarks: ''\n      }).then(res => {\n        if (res.data.code === 0) {\n          this.$message.success('分单成功')\n          this.companyList = []\n          this.orderMerge = {}\n          this.dataCompany = []\n          this.getFactoryOrder()\n        } else {\n          this.$message.error(res.data.msg)\n        }\n        this.submitLoading = false\n      }).catch(() => {\n        this.submitLoading = false\n        this.$message.error('系统错误')\n      })\n    },\n    // 关闭抽屉\n    isDrawer(val) {\n      this.visible = val\n    },\n    // 查看产品详情\n    infoView(e, id, index) {\n      window.event ? window.event.cancelBubble = true : e.stopPropagation()\n      this.channelSkuId = id\n      this.selectIndex = index\n      this.visibleModal = true\n    },\n    getViewInfo(params) {\n      get(api.goodsView + `?skuId=${params}`)\n        .then(res => {\n          if (res.data.code === 0) {\n            this.goodsViewInfo = res.data.data\n            this.visible = true\n          }\n        })\n        .then(() => {\n          Bus.$emit('setBomButton', true)\n          Bus.$emit('basicInfo', {\n            skuId: this.goodsViewInfo.sku.id,\n            type: this.isModalActive\n          })\n        })\n        .catch(err => {\n          console.log(err)\n        })\n    },\n    handleCancel() {\n      this.selectBom = false\n    }\n  }\n}\n",{"version":3,"sources":["dispatch.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA4KA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"dispatch.vue","sourceRoot":"src/views/factorySale/dispatchOrder","sourcesContent":["<template>\n  <div class=\"dispatch\">\n    <a-row>\n      <a-col :span=\"12\" class=\"dispatch-left\">\n        <inputSearch :companyType=\"companyType\" @changeInput=\"changeInput\"></inputSearch>\n        <div class=\"order-list\">\n          <div\n            class=\"order-list-item demo-infinite-container\"\n            v-infinite-scroll=\"handleInfiniteOnLoad\"\n            :infinite-scroll-disabled=\"busy\"\n            :infinite-scroll-distance=\"10\"\n          >\n            <a-list :dataSource=\"dataCompany\">\n              <a-list-item slot=\"renderItem\" slot-scope=\"item, index\">\n                <div\n                  class=\"list-item\"\n                  @click=\"addCompany(item.channelSkuId,index,item.number,item.odRequireDueDate)\"\n                >\n                  <div class=\"item-left\">\n                    <div class=\"item-left-top\">\n                      <a\n                        href=\"javascript:;\"\n                        @click=\"e=>infoView(e,item.channelSkuId,index)\"\n                      >{{item.name}}</a>\n                      <span>{{item.bom}} {{item.craft}}</span>\n                    </div>\n                    <ul class=\"item-left-desc\">\n                      <li>{{item.spec}}</li>\n                      <li>{{item.cz}}</li>\n                      <li>{{item.odRequireDueDate?moment(item.odRequireDueDate).format(dateFormat):''}}</li>\n                      <li>{{item.number}}{{item.unit}}</li>\n                    </ul>\n                  </div>\n                  <div class=\"item-right\">\n                    <a-popover trigger=\"click\" v-model=\"item.clickedVisible\">\n                      <template slot=\"content\">\n                        <a-form-item\n                          label=\"交期\"\n                          :label-col=\"{ span: 5,offset:0 }\"\n                          :wrapper-col=\"{span:12}\"\n                          class=\"mb\"\n                        >\n                          <a-date-picker\n                            v-if=\"updateList.date\"\n                            format=\"YYYY-MM-DD\"\n                            :value=\"moment(updateList.date, 'YYYY-MM-DD')\"\n                            style=\"width:170px;\"\n                            @change=\"updateTime\"\n                          />\n                          <a-date-picker\n                            v-else\n                            format=\"YYYY-MM-DD\"\n                            style=\"width:170px;\"\n                            @change=\"updateTime\"\n                          />\n                        </a-form-item>\n                        <a-form-item\n                          label=\"数量\"\n                          :label-col=\"{ span: 5,offset:0 }\"\n                          :wrapper-col=\"{span:12}\"\n                          class=\"mb\"\n                        >\n                          <a-input-number\n                            :min=\"1\"\n                            :max=\"item.number\"\n                            v-model=\"updateList.num\"\n                            style=\"width:170px;\"\n                          />\n                        </a-form-item>\n                        <a-form-item class=\"mb\">\n                          <a-button @click=\"uploadBom(item,index)\">修改BOM/工艺</a-button>\n                        </a-form-item>\n                        <a-form-item class=\"mb\" v-show=\"getMenuPermission.includes('DELETE')\">\n                          <a-button type=\"danger\" @click=\"removeItem(item.id,index)\">移除</a-button>\n                        </a-form-item>\n                        <a-form-item class=\"mb\">\n                          <a-button type=\"primary\" @click=\"addLittle(item.channelSkuId,index)\">确定</a-button>\n                        </a-form-item>\n                      </template>\n                      <a-icon\n                        type=\"ellipsis\"\n                        class=\"item-right-edit\"\n                        @click=\"e=>updataDes(e,item.number,item.odRequireDueDate, index)\"\n                      />\n                    </a-popover>\n                    <a-button type=\"primary\" shape=\"circle\" icon=\"plus\"></a-button>\n                  </div>\n                </div>\n              </a-list-item>\n              <div v-if=\"loadingCompony && !busy\" class=\"demo-loading-container\">\n                <a-spin />\n              </div>\n            </a-list>\n          </div>\n        </div>\n      </a-col>\n      <a-col :span=\"12\" class=\"dispatch-right\">\n        <div class=\"title\"></div>\n        <div class=\"order-list demo-infinite-container\">\n          <a-list :dataSource=\"companyList\">\n            <a-list-item slot=\"renderItem\" slot-scope=\"item, index\">\n              <div class=\"list-item\">\n                <div class=\"item-left\">\n                  <div class=\"item-left-top\">\n                    <a href=\"javascript:;\">{{item.name}}</a>\n                    <span>{{item.bom}} {{item.craft}}</span>\n                  </div>\n                  <ul class=\"item-left-desc\">\n                    <li>{{item.spec}}</li>\n                    <li>{{item.cz}}</li>\n                    <li>{{item.odRequireDueDate?moment(item.odRequireDueDate).format(dateFormat):''}}</li>\n                    <li>{{item.number}}{{item.unit}}</li>\n                  </ul>\n                </div>\n                <div class=\"item-right\">\n                  <a-button\n                    type=\"danger\"\n                    shape=\"circle\"\n                    icon=\"minus\"\n                    style=\"background:#f5222d;color:#fff;\"\n                    @click=\"minusCompany(index)\"\n                  ></a-button>\n                </div>\n              </div>\n            </a-list-item>\n          </a-list>\n          <div style=\"height:40px\"></div>\n          <div class=\"dispatch-right-bottom\">\n            <a-button @click=\"minusCompany\">取消</a-button>\n            <a-button\n              type=\"primary\"\n              @click=\"submit\"\n              :loading=\"submitLoading\"\n              v-show=\"getMenuPermission.includes('ADD')\"\n            >生成工单</a-button>\n          </div>\n        </div>\n      </a-col>\n    </a-row>\n    <!-- Moadl -->\n    <a-modal title=\"选择BOM\" :visible=\"visibleModal\" @ok=\"onModalOk\" @cancel=\"onModalNo\">\n      <ul class=\"bom-modal-list\">\n        <li\n          :class=\"{modalActive: isModalActive === 0 ? true : false}\"\n          @click=\"onModalInfo(0)\"\n        >设置工艺和BOM</li>\n        <li\n          :class=\"{modalActive: isModalActive === 1 ? true : false}\"\n          @click=\"onModalInfo(1)\"\n        >选择工艺和BOM</li>\n      </ul>\n    </a-modal>\n    <!-- 产品信息抽屉 -->\n    <a-drawer\n      destroyOnClose\n      placement=\"right\"\n      :closable=\"false\"\n      @close=\"closeDrawer\"\n      :visible=\"visible\"\n      :width=\"1040\"\n      :wrapStyle=\"{height: '100%',overflow: 'auto',paddingBottom: '108px'}\"\n    >\n      <dispatchInfo\n        @isDrawer=\"isDrawer\"\n        @setDispatchInfo=\"setDispatchInfo\"\n        :goodsViewInfo=\"goodsViewInfo\"\n      ></dispatchInfo>\n    </a-drawer>\n  </div>\n</template>\n\n<script>\nimport Bus from '@/Bus.js'\nimport infiniteScroll from 'vue-infinite-scroll'\nimport { postJson, get } from '@/api/axios.js'\nimport api from '@/api/index.js'\nimport moment from 'moment'\nimport dispatchInfo from '@/views/product/pdm/goods/child_info/GoodsInfo'\nimport inputSearch from '@/views/sale/dispatchOrder/other/inputSearch'\nimport { mixinBasic, mixinDrawer } from '@/components/tools/mixin/mixin'\nexport default {\n  directives: { infiniteScroll },\n  mixins: [mixinBasic, mixinDrawer],\n  components: {\n    dispatchInfo,\n    inputSearch\n  },\n  data() {\n    return {\n      companyType: 'FACTORY',\n      dateFormat: 'YYYY-MM-DD',\n      busy: false,\n      loadingCompony: false,\n      dataCompanySize: 0,\n      dataCompany: [],\n      orderMerge: [],\n      currentPage: 1,\n      pageSize: 15,\n      searchTerm: {},\n      updateList: {\n        num: 0,\n        date: ''\n      },\n      companyList: [],\n      submitLoading: false,\n      goodsViewInfo: {},\n      visibleModal: false,\n      selectIndex: '',\n      isModalActive: 0,\n      channelSkuId: ''\n    }\n  },\n  computed: {\n    getMenuPermission() {\n      return this.$store.state.menuPermission\n    }\n  },\n  methods: {\n    moment,\n    // 按条件搜索渠道商订单列表\n    changeInput(val, type) {\n      this.dataCompany = []\n      this.searchTerm = val\n      this.getFactoryOrder()\n    },\n    // 滚动滑动条加载订单\n    handleInfiniteOnLoad() {\n      const data = this.dataCompany\n      this.loadingCompony = true\n      this.busy = true\n      if (data.length >= this.dataCompanySize && this.dataCompanySize !== 0) {\n        this.busy = true\n        this.loadingCompony = false\n      } else {\n        this.getFactoryOrder(this.currentPage)\n        this.busy = false\n        this.loadingCompony = false\n      }\n    },\n    // 移除订单\n    removeItem(id, index) {\n      const _this = this\n      this.$confirm({\n        title: '移除订单信息',\n        content: '您确定要移除这条订单消息吗?',\n        zIndex: 99999,\n        onOk() {\n          postJson(api.delFactoryPolicyOrder, { id }).then(res => {\n            if (res.data.code === 0) {\n              _this.$message.success('订单移除成功')\n              _this.dataCompany.splice(index, 1)\n              _this.dataCompanySize--\n            } else {\n              _this.$message.error(res.data.msg)\n            }\n          })\n        },\n        onCancel() { }\n      })\n    },\n    addCompany(channelSkuId, index, num, date) {\n      this.dispatchAction(channelSkuId, index, num, date)\n    },\n    addLittle(channelSkuId, index) {\n      const updateList = this.updateList\n      this.dispatchAction(channelSkuId, index, updateList.num, updateList.date)\n    },\n    /**\n    * @description 订单分派\n    * @param channelSkuId 产品SkuID 查询产品详情\n    * @param index 当前点击的索引\n    * @description 先判断是否设置制造工艺和BOM\n    * 一、设置。判断是否已经添加过产品。已经有添加的产品则在进行判断规格、材质、制造工艺、BOM是否一致，一致则添加不一致则警告；如果没有添加过产品则直接将 产品添加过去。\n    * 二、未设置。提示用户先设置制造工艺和BOM，确定设置则直接右侧抽屉展开\n    */\n    dispatchAction(channelSkuId, index, num, date) {\n      this.selectIndex = index\n      this.channelSkuId = channelSkuId\n      const dataCompany = this.dataCompany\n      const companyList = this.companyList\n      const item = dataCompany[index]\n      const target = JSON.parse(JSON.stringify(item))\n      const tar = companyList.filter(itm => itm.odRequireDueDate === date)[0]\n      dataCompany[index].clickedVisible = false\n      if (item.bom === null || item.craft === null) {\n        this.visibleModal = true\n        this.channelSkuId = channelSkuId\n        return\n      }\n      if (companyList.length !== 0) {\n        if (item.channelSkuId !== companyList[0].channelSkuId) {\n          this.$message.warning('不同产品不能合并生成工单。')\n          return\n        }\n        if (item.bomGroupId !== companyList[0].bomGroupId || item.craftGroupId !== companyList[0].craftGroupId) {\n          this.$message.warning('不同制造工艺和BOM不能合并生成工单。')\n          return\n        }\n        if (!tar) {\n          this.$message.warning('不同的交期不能合并生成工单')\n          return\n        }\n        const tarList = companyList.filter(itm => itm.id === item.id)[0]\n        if (!tarList) {\n          target.odRequireDueDate = date\n          target.number = num\n          companyList.push(target)\n        } else {\n          tarList.number += num\n        }\n        if (num >= item.number) {\n          dataCompany.splice(index, 1)\n        } else {\n          item.number -= num\n        }\n      } else {\n        target.odRequireDueDate = date\n        target.number = num\n        if (num >= item.number) {\n          dataCompany.splice(index, 1)\n        } else {\n          item.number -= num\n        }\n        companyList.push(target)\n      }\n    },\n    uploadBom(item, index) {\n      this.selectIndex = index\n      this.dataCompany[index].clickedVisible = false\n      this.channelSkuId = item.channelSkuId\n      this.isModalActive = 1\n      this.onModalOk()\n    },\n    // MOdal\n    onModalOk() {\n      this.visibleModal = false\n      this.getViewInfo(this.channelSkuId)\n      this.$store.commit('setPromptTitle', {\n        title: '产品信息',\n        isEdit: true\n      })\n    },\n    onModalNo() {\n      this.visibleModal = false\n    },\n    setDispatchInfo(val) {\n      const dataCompany = this.dataCompany\n      const index = this.selectIndex\n      const bom = val[0]\n      const craft = val[1]\n      const data = {}\n      data.id = dataCompany[index].id\n      data.bomGroupId = bom.id\n      data.craftGroupId = craft.productCraftId\n      postJson(api.updateBomCraft, data).then(res => {\n        if (res.data.code === 0) {\n          dataCompany[index].bom = bom.inputVal\n          dataCompany[index].craft = craft.inputVal\n          this.$message.success('设置工艺和BOM成功')\n          this.visible = false\n        } else {\n          this.$message.error(res.data.msg)\n        }\n      })\n    },\n    // Modal Tabs\n    onModalInfo(key) {\n      this.isModalActive = key\n    },\n    // 删除工厂中的订单\n    minusCompany(index) {\n      if (index >= 0) {\n        const companyList = this.companyList\n        const dataCompany = this.dataCompany\n        const item = companyList[index]\n        const target = dataCompany.filter(itm => itm.id === item.id)[0]\n        if (target) {\n          target.number += item.number\n        } else {\n          dataCompany.push(item)\n          this.dataCompanySize += 1\n        }\n        companyList.splice(index, 1)\n      } else {\n        this.companyList = []\n        this.dataCompany = []\n        this.getFactoryOrder()\n      }\n    },\n    // 获取工厂订单列表\n    getFactoryOrder(currentPage = 1, pageSize = 15) {\n      const data = this.searchTerm\n      data.currentPage = currentPage\n      data.pageSize = pageSize\n      postJson(api.getFactoryPolicyOrder, data).then(res => {\n        if (res.data.code === 0) {\n          const data = res.data.data.records\n          this.dataCompanySize = Number(res.data.data.total)\n          if (data.length) {\n            data.forEach(item => {\n              item.clickedVisible = false\n            })\n            this.dataCompany = this.dataCompany.concat(data)\n          }\n          this.currentPage += 1\n        }\n      }).catch(() => {\n        this.$message.error('系统错误')\n      })\n    },\n    updataDes(e, num, data, index) {\n      window.event ? window.event.cancelBubble = true : e.stopPropagation()\n      const updateList = this.updateList\n      updateList.num = num\n      updateList.date = data\n      this.dataCompany[index].clickedVisible = true\n    },\n    updateTime(dates, dateStrings) {\n      this.updateList.date = dateStrings\n    },\n    // 订单分派提交\n    submit() {\n      if (this.companyList.length === 0) {\n        return\n      }\n      this.submitLoading = true\n      const list = []\n      var totalNumber = null\n      var odRequireDueDate = null\n      this.companyList.forEach(item => {\n        list.push({\n          id: item.id,\n          number: item.number\n        })\n        totalNumber += item.number\n        odRequireDueDate = item.odRequireDueDate\n      })\n      postJson(api.putFactoryPolicyOrderAdd, {\n        list,\n        totalNumber: totalNumber,\n        odRequireDueDate: odRequireDueDate,\n        remarks: ''\n      }).then(res => {\n        if (res.data.code === 0) {\n          this.$message.success('分单成功')\n          this.companyList = []\n          this.orderMerge = {}\n          this.dataCompany = []\n          this.getFactoryOrder()\n        } else {\n          this.$message.error(res.data.msg)\n        }\n        this.submitLoading = false\n      }).catch(() => {\n        this.submitLoading = false\n        this.$message.error('系统错误')\n      })\n    },\n    // 关闭抽屉\n    isDrawer(val) {\n      this.visible = val\n    },\n    // 查看产品详情\n    infoView(e, id, index) {\n      window.event ? window.event.cancelBubble = true : e.stopPropagation()\n      this.channelSkuId = id\n      this.selectIndex = index\n      this.visibleModal = true\n    },\n    getViewInfo(params) {\n      get(api.goodsView + `?skuId=${params}`)\n        .then(res => {\n          if (res.data.code === 0) {\n            this.goodsViewInfo = res.data.data\n            this.visible = true\n          }\n        })\n        .then(() => {\n          Bus.$emit('setBomButton', true)\n          Bus.$emit('basicInfo', {\n            skuId: this.goodsViewInfo.sku.id,\n            type: this.isModalActive\n          })\n        })\n        .catch(err => {\n          console.log(err)\n        })\n    },\n    handleCancel() {\n      this.selectBom = false\n    }\n  }\n}\n</script>\n\n<style lang=\"less\" scoped>\n@import \"~styles/dispach.less\";\n\n.bom-modal-list {\n  text-align: center;\n  li {\n    display: inline-block;\n    width: 140px;\n    height: 60px;\n    margin: 0 10px;\n    border: 1px solid #d9d9d9;\n    line-height: 60px;\n    text-align: center;\n    border-radius: 4px;\n    box-sizing: border-box;\n    cursor: pointer;\n  }\n  .modalActive {\n    border: 1px solid #1890ff;\n  }\n}\n</style>\n"]}]}